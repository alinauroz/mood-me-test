<html>
    <head>
        <title>Emotion Charts</title>
        <script type="text/javascript" src="https://unpkg.com/lodash@4.17.20/lodash.min.js"></script>
        <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
        <script type="text/javascript"src="./emotions.js"></script>
        <script>

            function getUsers (data) {
                const users = new Set();
                data.forEach(entry => users.add(entry.participantId));
                return Array.from(users);
            }

            window.onload = () => {

                /**
                 * creates a input[type=button]
                 * @param   {String}       value
                 * @param   {function}     onClick  
                 * @returns {HTMLElement}
                */

                function Button ({value, onClick}) {
                    let button = document.createElement('input');
                    button.type = 'button';
                    button.value = value;
                    button.onclick = onClick;
                    return button;
                }

                /**
                 * returns a input[type=checkbox] wrapped in a container
                 * @param   {String}    label
                 * @param   {String}    id
                 * @param   {function}  onChecked
                 * @param   {function}  onUnchecked
                 * @returns {HTMLElement}
                */

                function CheckBox ({label, id, checked = false, onChecked = null, onUnchecked = null}) {
                    let container = document.createElement('span')
                    let callback = document.createElement('input');
                    let _label = document.createElement('label');

                    callback.type = 'checkbox';
                    callback.id = id;
                    callback.onclick = (e) => e.target.checked ? onChecked(e) : onUnchecked(e);
                    callback.checked = checked;

                    _label.innerHTML = label;
                    _label.setAttribute('for', id);
                    container.appendChild(callback);
                    container.appendChild(_label);

                    return container;
                }

                /**
                 * renders an array of HTML elements in container
                 * @param   {Array.<HTMLElement>}   elements
                 * @param   {HTMLElement}           container
                */

                function render (elements, container) {
                    elements.forEach(el => container.append( el ));
                }

                /**
                 * renders a graph using canvas JS
                 * @param   {HTMLElement}       container   -   the container of char
                 * @param   {Array.<Object>}    users       -   the emotions data array
                */

                function renderChart (container, users) {
                    let i = 0;
                    const data = [];
                    for (let user of users) {
                        let userData = _.filter(EMOTIONS.data, {participantId: user });

                        let dataPoints = userData.map(entry => ({x: new Date(entry.timestamp).getMinutes() * 60 + new Date(entry.timestamp).getSeconds(), y: entry.attention}))
                        console.log(dataPoints)
                        data.push({type: 'line', dataPoints});
                    }

                    let chart = new CanvasJS.Chart(container, {
                        title: {
                            text: 'Emotions Graph'
                        },
                        theme: 'light',
                        data
                    });

                    chart.render();

                }

                let users = getUsers(EMOTIONS.data);
                const usersToRender = new Set(users);

                const checkBoxes = users.map(user => CheckBox({
                    label: user,
                    id: user,
                    checked: true,
                    onChecked: () => updateUsersToRender(user, usersToRender.add.bind(usersToRender)),
                    onUnchecked: () => updateUsersToRender(user, usersToRender.delete.bind(usersToRender))
                }))

                function updateUsersToRender(value, func) {
                    func(value);
                    renderChart('chart-container', usersToRender);
                }
                
                render(
                    checkBoxes,
                    document.getElementById('users-cb')
                );
                //renderChart('chart-container', usersToRender);

            }

        </script>
        <style>
            body {
                font-family: 'arial', sans-serif;
            }

            #chart-container {
                margin-top: 100px;
            }
            #users-cb h3 {
                margin: 3px 0px 0px 0px;
            }
            #users-cb p {
                margin: 0px 0px 5px 0px;
            }
        </style>
    </head>
    <body>
        <div id = 'users-cb'>
            <h3>Participants</h3>
            <p>Below is a list of unique users found in the data</p>
        </div>
        <div id = 'chart-container'></div>
    </body>
</html>